# Dyno Scheduler - Scale dynos up/down to save Eco hours
# Schedule: 10:00 AM - 08:00 PM Uzbekistan time (UTC+5) = 05:00 - 15:00 UTC
# Scale UP at 05:00 UTC, Scale DOWN at 15:00 UTC
# 6 dynos Ã— 10 hours/day Ã— 30 days = 1,800 hours/month (under 2,000 limit)

name: Dyno Scheduler

on:
  schedule:
    - cron: '0 5 * * *'   # Scale UP at 05:00 UTC (10:00 AM Uzbekistan)
    - cron: '0 15 * * *'  # Scale DOWN at 15:00 UTC (08:00 PM Uzbekistan)
  workflow_dispatch:  # Manual trigger

env:
  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

jobs:
  scale-dynos:
    runs-on: ubuntu-latest
    name: Scale Dynos

    steps:
      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Determine Action
        id: action
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" -eq "5" ]; then
            echo "scale=1" >> $GITHUB_OUTPUT
            echo "action=UP" >> $GITHUB_OUTPUT
          elif [ "$HOUR" -eq "15" ]; then
            echo "scale=0" >> $GITHUB_OUTPUT
            echo "action=DOWN" >> $GITHUB_OUTPUT
          else
            echo "scale=1" >> $GITHUB_OUTPUT
            echo "action=UP" >> $GITHUB_OUTPUT
          fi

      - name: Scale API Gateway
        run: |
          echo "Scaling API Gateway to ${{ steps.action.outputs.scale }}..."
          heroku ps:scale web=${{ steps.action.outputs.scale }} -a ${{ secrets.HEROKU_APP_API_GATEWAY }}

      - name: Scale Auth Service
        run: |
          echo "Scaling Auth Service to ${{ steps.action.outputs.scale }}..."
          heroku ps:scale web=${{ steps.action.outputs.scale }} -a ${{ secrets.HEROKU_APP_AUTH }}

      - name: Scale Wallet Service
        run: |
          echo "Scaling Wallet Service to ${{ steps.action.outputs.scale }}..."
          heroku ps:scale web=${{ steps.action.outputs.scale }} -a ${{ secrets.HEROKU_APP_WALLET }}

      - name: Scale Customer Service
        run: |
          echo "Scaling Customer Service to ${{ steps.action.outputs.scale }}..."
          heroku ps:scale web=${{ steps.action.outputs.scale }} -a ${{ secrets.HEROKU_APP_CUSTOMER }}

      - name: Scale Ledger Service
        run: |
          echo "Scaling Ledger Service to ${{ steps.action.outputs.scale }}..."
          heroku ps:scale web=${{ steps.action.outputs.scale }} -a ${{ secrets.HEROKU_APP_LEDGER }}

      - name: Scale Notification Service
        run: |
          echo "Scaling Notification Service to ${{ steps.action.outputs.scale }}..."
          heroku ps:scale web=${{ steps.action.outputs.scale }} -a ${{ secrets.HEROKU_APP_NOTIFICATION }}

      - name: Summary
        run: |
          echo "âœ… All dynos scaled ${{ steps.action.outputs.action }} to ${{ steps.action.outputs.scale }}"
          if [ "${{ steps.action.outputs.action }}" == "UP" ]; then
            echo "ðŸ’¡ Dynos are now ACTIVE (10:00 AM - 08:00 PM Uzbekistan time)"
          else
            echo "ðŸ’¤ Dynos are now SLEEPING to save hours (08:00 PM - 10:00 AM Uzbekistan time)"
          fi

